<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>燈光編輯器</title>
  <script src="google-blockly/blockly_compressed.js"></script>
  <script src="google-blockly/blocks_compressed.js"></script>
  <script src="google-blockly/javascript_compressed.js"></script>
  <script src="google-blockly/msg/js/zh-hant.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
  <style>
    * {
      margin: 0;
      box-sizing: border-box;
    }
    html, body {
      height: 100%;
        overflow: hidden;
    }
    #main > * {
      display: inline-block;
    }
    #menu > ul > li {
      margin-left: 2em;
      display: inline-block;
    }
    #menu > ul > li::before {
      content: '> ';
    }
  </style>
</head>
<body>
  <div id="menu" style="width:100%; height: 20px">
      <span>燈光編輯器</span>
  </div>
    <script>
        function dontcopy() {
          /*
            alert("不給複製唷~ >_^");
            return false;
          */
        }
    </script>
  <div id="main" style="width:100%; height:auto; position:absolute; top:20px; bottom:0">
    <div id="blocklyDiv" style="height:100%; width: 95%;"></div>
    <div style="height:100%; width:3em">
        <button id="upload" style="position:absolute; margin:auto; top:0; height:3em; width:3em" onclick="javascript:uploadColorCode();">上傳</button>
        <button id="import" style="position:absolute; margin:auto; bottom:0; height:3em; width:3em" onclick="javascript:Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(document.getElementById('msg').value), workspace);">&lt;</button>
    </div>
    <pre style="height:90%; width: 1%; position:absolute; top:0" oncopy="return dontcopy()" oncut="return dontcopy()" onpaste="return dontcopy()"><code id="c_code" class="cpp"></code></pre>
    <textarea id="msg" style="height:5%; width: 1%; position:absolute; bottom:0"></textarea>
  </div>

  <xml xmlns="http://www.w3.org/1999/xhtml" id="toolbox" style="display: none;">
    <block type="colour_picker">
      <field name="COLOUR">#ff0000</field>
    </block>
    <block type="colour_random"></block>
    <block type="colour_rgb">
      <value name="RED">
        <shadow type="math_number">
          <field name="NUM">100</field>
        </shadow>
      </value>
      <value name="GREEN">
        <shadow type="math_number">
          <field name="NUM">50</field>
        </shadow>
      </value>
      <value name="BLUE">
        <shadow type="math_number">
          <field name="NUM">0</field>
        </shadow>
      </value>
    </block>
    <block type="colour_blend">
      <value name="COLOUR1">
        <shadow type="colour_picker">
          <field name="COLOUR">#ff0000</field>
        </shadow>
      </value>
      <value name="COLOUR2">
        <shadow type="colour_picker">
          <field name="COLOUR">#3333ff</field>
        </shadow>
      </value>
      <value name="RATIO">
        <shadow type="math_number">
          <field name="NUM">0.5</field>
        </shadow>
      </value>
    </block>
    <block type="litectl2">
      <value name="time">
        <block type="math_number">
          <field name="NUM">1000</field>
        </block>
      </value>
    </block>
    <block type="litectl">
      <value name="time">
        <block type="math_number">
          <field name="NUM">1000</field>
        </block>
      </value>
    </block>
  </xml>

  <xml id="startBlocks" style="display: none">
      <variables></variables>
      <block type="litectl2" id="(!5a_Hcq#ljqCgKRZsV." x="176" y="17">
          <value name="color">
            <block type="colour_picker" id="ClUG^rCS_PE-l[r:QJFB">
              <field name="COLOUR">#ffffff</field>
            </block>
          </value>
          <value name="time">
            <block type="math_number" id="0;8lx:I*8?BLPXQh!HmM">
              <field name="NUM">1000</field>
            </block>
          </value>
          <next>
            <block type="litectl2" id=",v/ie?a2@dK`Yohy~X|-">
              <value name="color">
                <block type="colour_random" id="DbZ5:R/Rks6a^3oPJ}Pm"></block>
              </value>
              <value name="time">
                <block type="math_number" id="I?#1:Z(VJ%o=nUn*QOgM">
                  <field name="NUM">1000</field>
                </block>
              </value>
              <next>
                <block type="litectl" id="tW,*J@OmsHd;vw_5~R.=">
                  <value name="color">
                    <block type="colour_rgb" id="Y--!_,dU[Cv8_nH5,2iA">
                      <value name="RED">
                        <block type="math_number" id=":W]v;B)sEE@#2Ai+|*;g">
                          <field name="NUM">100</field>
                        </block>
                      </value>
                      <value name="GREEN">
                        <block type="math_number" id="vpCev.$P#*T/39|MwA7p">
                          <field name="NUM">0</field>
                        </block>
                      </value>
                      <value name="BLUE">
                        <block type="math_number" id=")c|*f;{K@2@j~#YgE#q9">
                          <field name="NUM">0</field>
                        </block>
                      </value>
                    </block>
                  </value>
                  <value name="time">
                    <block type="math_number" id="D/z;GlWkWUxW2%P~,|*s">
                      <field name="NUM">1000</field>
                    </block>
                  </value>
                  <next>
                    <block type="litectl" id="fQT*sxF,OtRi8y/%Yg?[">
                      <value name="color">
                        <block type="colour_rgb" id="[_oHPCH}3Xs:e7TLePa*">
                          <value name="RED">
                            <block type="math_number" id=".t3!F$jzmkO.5HbP8*a;">
                              <field name="NUM">0</field>
                            </block>
                          </value>
                          <value name="GREEN">
                            <block type="math_number" id="~7{c[X)6%nqc%Wr4w}0O">
                              <field name="NUM">100</field>
                            </block>
                          </value>
                          <value name="BLUE">
                            <block type="math_number" id="M)MBM[gVG7h$T;N|8;YR">
                              <field name="NUM">0</field>
                            </block>
                          </value>
                        </block>
                      </value>
                      <value name="time">
                        <block type="math_number" id="|2bcSo1qG0qiA/D@[hyy">
                          <field name="NUM">1000</field>
                        </block>
                      </value>
                      <next>
                        <block type="litectl" id="y4RGgT:2gTAl}T~7lH^u">
                          <value name="color">
                            <block type="colour_rgb" id="c!qO}9rg=]$]Sr}.x]-w">
                              <value name="RED">
                                <block type="math_number" id="+6oSm+7ug4F#o|?8|S0G">
                                  <field name="NUM">0</field>
                                </block>
                              </value>
                              <value name="GREEN">
                                <block type="math_number" id="HNf^Wb#|d4x8zm4[#}ew">
                                  <field name="NUM">0</field>
                                </block>
                              </value>
                              <value name="BLUE">
                                <block type="math_number" id="8%Ey,:ePy$M-*vj3MfYl">
                                  <field name="NUM">100</field>
                                </block>
                              </value>
                            </block>
                          </value>
                          <value name="time">
                            <block type="math_number" id="2xJ$H:gf^vE[+JxY9l}t">
                              <field name="NUM">1000</field>
                            </block>
                          </value>
                        </block>
                      </next>
                    </block>
                  </next>
                </block>
              </next>
            </block>
          </next>
        </block>
  </xml>
  
  <script>
    Blockly.Blocks['litectl'] = {
      init: function() {
        this.appendValueInput("color")
            .setCheck(null)
            .appendField("顏色漸變");
        this.appendValueInput("time")
            .setCheck("Number")
            .appendField("時間(ms)");
        this.setInputsInline(false);
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(230);
        this.setTooltip("");
        this.setHelpUrl("");
      }
    };
    Blockly.JavaScript['litectl'] = function(block) {
      var value_color = Blockly.JavaScript.valueToCode(block, 'color', Blockly.JavaScript.ORDER_ATOMIC);
      var value_time = Blockly.JavaScript.valueToCode(block, 'time', Blockly.JavaScript.ORDER_ATOMIC);
      // TODO: Assemble JavaScript into code variable.
      var code = "colorCode += genColor("+value_color+", "+value_time+");" + '\n';
      return code;
    };
    Blockly.Blocks['litectl2'] = {
      init: function() {
        this.appendValueInput("color")
            .setCheck(null)
            .appendField("固定顏色");
        this.appendValueInput("time")
            .setCheck("Number")
            .appendField("時間(ms)");
        this.setInputsInline(false);
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(200);
        this.setTooltip("");
        this.setHelpUrl("");
      }
    };
    Blockly.JavaScript['litectl2'] = function(block) {
      var value_color = Blockly.JavaScript.valueToCode(block, 'color', Blockly.JavaScript.ORDER_ATOMIC);
      var value_time = Blockly.JavaScript.valueToCode(block, 'time', Blockly.JavaScript.ORDER_ATOMIC);
      // TODO: Assemble JavaScript into code variable.
      var code = "colorCode += genColor2("+value_color+", "+value_time+");" + '\n';
      return code;
    };
  </script>

  <script>
    //var param = window.location.toString().split('?');
    //if (param.length>1) param = param[1];
    //else                param = null;

    var workspace = Blockly.inject('blocklyDiv',
        {media: 'google-blockly/media/',
         toolbox: document.getElementById('toolbox'),
         zoom: {
           controls: true,
           wheel: true
         },
         collapse: true,
         disable: true,
         scrollbars: true,
         trashcan: true
        });
    //if (param!=null && typeof ansXml[param]!=='undefined') {
    //    Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(ansXml[param]), workspace);
    //}
    //else {
        Blockly.Xml.domToWorkspace(document.getElementById('startBlocks'), workspace);
    //}
  </script>
  <script>
    var colorGenFunc = ' \
    function genColor(color, time) { \
      var r1 = parseInt(color.substring(1, 3), 16); \
      var g1 = parseInt(color.substring(3, 5), 16); \
      var b1 = parseInt(color.substring(5, 7), 16); \
      var retv = ""; \
      retv += (r1+"    ").slice(0,4); \
      retv += (g1+"    ").slice(0,4); \
      retv += (b1+"    ").slice(0,4); \
      retv += (time+"       ").slice(0,7); \
      retv += "\\n"; \
      return retv; \
    }\n \
    function genColor2(color, time) { \
      return genColor(color, time)+genColor(color, 1); \
    } \
    ';
    workspace.addChangeListener(function(event){
      var xml = Blockly.Xml.workspaceToDom(workspace);
      var xml_text = Blockly.Xml.domToText(xml);
      document.getElementById("msg").value = xml_text;

      c_code = "colorCode=''; " + "\n" + colorGenFunc + "\n" + Blockly.JavaScript.workspaceToCode(workspace);
      document.getElementById('c_code').textContent = c_code;
      hljs.highlightBlock(document.getElementById('c_code'));
    });
  </script>
  <script>
    function uploadColorCode() {
      eval(c_code);
      console.log(colorCode);

      var http = new XMLHttpRequest();
      var url = "http://wolfoj.wolfdigit.ga/lite2upload.php";
      var params = "colorCode="+colorCode;
      http.open("POST", url, true);

      //Send the proper header information along with the request
      http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

      http.onreadystatechange = function() {//Call a function when the state changes.
          if(http.readyState == 4 && http.status == 200) {
              console.log(http.responseText);
          }
      }
      http.send(params);
    }
  </script>
</body>
</html>
